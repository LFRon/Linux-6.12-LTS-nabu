From 589ef9ae708de752459ebb269e3832a0a8e4e9b6 Mon Sep 17 00:00:00 2001
From: Nicola Guerrera <guerrera.nicola@gmail.com>
Date: Tue, 5 Aug 2025 18:34:07 +0200
Subject: [PATCH 18/19] dts: qcom: sm8150: enable pm8150b_charger

---
 arch/arm64/boot/dts/qcom/pm8150b.dtsi         | 32 +++++++++++++++++++
 .../boot/dts/qcom/sm8150-xiaomi-nabu.dts      | 11 +++++--
 2 files changed, 40 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/boot/dts/qcom/pm8150b.dtsi b/arch/arm64/boot/dts/qcom/pm8150b.dtsi
index 97361a586be9..b7c3452aee48 100644
--- a/arch/arm64/boot/dts/qcom/pm8150b.dtsi
+++ b/arch/arm64/boot/dts/qcom/pm8150b.dtsi
@@ -107,6 +107,26 @@ pm8150b_temp: temp-alarm@2400 {
 			#thermal-sensor-cells = <0>;
 		};
 
+		pm8150b_charger: charger@1000 {
+			compatible = "qcom,pm8150b-charger";
+			reg = <0x1000>;
+
+			interrupts = <0x2 0x13 0x4 IRQ_TYPE_EDGE_BOTH>,
+				     <0x2 0x12 0x2 IRQ_TYPE_EDGE_BOTH>,
+				     <0x2 0x16 0x1 IRQ_TYPE_EDGE_RISING>,
+				     <0x2 0x13 0x7 IRQ_TYPE_EDGE_RISING>;
+			interrupt-names = "usb-plugin",
+					  "bat-ov",
+					  "wdog-bark",
+					  "usbin-icl-change";
+
+			io-channels = <&pm8150b_adc ADC5_USB_IN_I>,
+				      <&pm8150b_adc ADC5_USB_IN_V_16>;
+			io-channel-names = "usbin_i", "usbin_v";
+
+			status = "disabled";
+		};
+
 		pm8150b_adc: adc@3100 {
 			compatible = "qcom,spmi-adc5";
 			reg = <0x3100>;
@@ -133,6 +153,18 @@ channel@6 {
 				label = "die_temp";
 			};
 
+			channel@7 {
+				reg = <ADC5_USB_IN_I>;
+				qcom,pre-scaling = <1 1>;
+				label = "usbin_i";
+			};
+
+			channel@8 {
+				reg = <ADC5_USB_IN_V_16>;
+				qcom,pre-scaling = <1 16>;
+				label = "usbin_v";
+			};\
+
 			channel@9 {
 				reg = <ADC5_CHG_TEMP>;
 				qcom,pre-scaling = <1 1>;
diff --git a/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu.dts b/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu.dts
index 864acb55cb5e..d79d2b5fdd01 100644
--- a/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu.dts
+++ b/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu.dts
@@ -505,7 +505,7 @@ ln8000_charger@51 {
 		compatible = "lionsemi,ln8000";
 		reg = <0x51>;
 
-		status = "okay";
+		status = "disabled";
 
 		irq-gpios = <&tlmm 36 0x2002>;
 
@@ -683,9 +683,15 @@ vol_up_n: vol-up-n-state {
 &pm8150b_fg {
 	status = "okay";
 	monitored-battery = <&battery>;
+	power-supplies = <&pm8150b_charger>;
 	//power-supplies = <&ln8000_charger>;
 };
 
+&pm8150b_charger {
+	status = "okay";
+	monitored-battery = <&battery>;
+};
+
 &pm8150b_typec {
 	vdd-pdphy-supply = <&vreg_l2a_3p1>;
 	status = "okay";
@@ -705,8 +711,7 @@ PDO_FIXED_USB_COMM |
 		sink-pdos = <PDO_FIXED(5000, 3000,
 					 PDO_FIXED_DUAL_ROLE |
 					 PDO_FIXED_USB_COMM |
-					 PDO_FIXED_DATA_SWAP)
-					 PDO_VAR(5000, 9000, 3000)>;
+					 PDO_FIXED_DATA_SWAP)>;
 
 		op-sink-microwatt = <10000000>;
 
-- 
2.51.0

